<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InterviewAce - AI Interview Coach</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3A86FF;
            --accent: #023E8A;
            --success: #28a745;
            --error: #dc3545;
            --info: #17a2b8;
            --text-color: #333;
            --bg-light: #f0f4f8;
            --white: #fff;
            --card-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            --radius: 12px;

            /* Light theme defaults */
            --bg-gradient: linear-gradient(-45deg, #ffc7d9, #aee2ff, #b9fbc0, #fff3a3);
            --card-bg: rgba(255, 255, 255, 0.9);
            --btn-gradient: linear-gradient(135deg, var(--primary), var(--accent));
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: pastelFlow 20s ease infinite;
            color: var(--text-color);
            overflow-y: auto;
        }


        body.dark {
            --text-color: #f0f0f0;
            --bg-gradient: linear-gradient(-45deg, #3A86FF, #8338ec, #ff006e, #00b4d8);
            --card-bg: rgba(40, 40, 40, 0.85);
            --btn-gradient: linear-gradient(135deg, #5c5cde, #3d3d9e);
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }

        
        .container {
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: var(--radius);
            padding: 40px;
            box-shadow: var(--card-shadow);
            width: 90%;
            max-width: 650px;
            text-align: center;
            margin: 40px 0;
            overflow-y: auto;
        }


        .container p {
            font-size: 1rem;
            color: #4a4a4a;
            margin-top: -15px;
            margin-bottom: 20px;
        }
                
        h1 {
            color: var(--accent);
            margin-bottom: 24px;
            font-weight: 700;
        }

        .section {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            margin-top: 20px;
        }

        .section.show {
            display: block;
            opacity: 1;
        }

        /* Status Indicator */
        .status-indicator {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: bold;
            color: #fff;
            z-index: 10;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: var(--card-shadow);
        }
        
        .status-indicator.show {
            display: block;
            opacity: 1;
        }
        
        .status-success { background-color: var(--success); }
        .status-error { background-color: var(--error); }
        .status-info { background-color: var(--info); }

        .form-group {
            margin-bottom: 24px;
            /* text-align: left; */
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: var(--radius);
            font-size: 16px;
            box-sizing: border-box;
        }

        .card-container {
            perspective: 1200px;
            width: 100%;
            /* max-width: 360px; */
            margin: auto;
            position: relative;
            height: 340px;
            overflow-y: auto;

        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s ease;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-sizing: border-box;
            /* box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); */
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 12px;
            overflow-y: auto;

        }

        .card-front {
            z-index: 2;
        }

        .card-back {
            transform: rotateY(180deg);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        input{
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            display: block;
        }
        
        .btn{
            background: var(--btn-gradient);
            color: #fff;
            padding: 12px 26px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            margin: 6px auto;
            display: block;
        }

        .link-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
            margin-top: 8px;
            padding: 5px;
        }

        .toggle {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            padding: 6px 10px;
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px
            
        }

        .toggle:focus {
            outline: none;
        }

        .card-front h2, .card-back h2{
        font-size: 1.5rem !important;
        font-weight: 600 !important;
        color: #1e3a8a !important;
        margin-bottom: 12px !important;
        }

        .hidden {
            display: none !important;
        } 

        body.dark .container {
            /* background: rgba(40, 40, 40, 0.85); */
            color: #f1f1f1;
            /* box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); */
        }

        body.dark .card-face {
            color: #f1f1f1;

        }
        body.dark .card-face h2 {
            color: #ffffff;
        }
        
        body.dark .card-face p,
        body.dark .card-face label {
            color: #ddd;
        }


        body.dark input {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border: 1px solid #444;
        }

        body.dark input::placeholder {
            color: #ccc;
        }

        body.dark .link-btn {
            color: #91cfff;
        }

        body.dark h1, 
        body.dark h2, 
        body.dark p {
            color: #f5f5f5;
        }

        body.dark button.btn {
            text-shadow: 0 0 4px rgba(255, 255, 255, 0.2);
        }
        
        body.dark .card-front h2,
        body.dark .card-back h2 {
            color: #ffffff !important;
        }

        /* Role Selection */
        .role-selection {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .role-card {
            background-color: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            width: 180px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .role-card:hover,
        .role-card.selected {
            border-color: var(--primary);
            background-color: #e7f1ff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }
        
        .role-card h3 {
            margin-bottom: 10px;
            color: var(--accent);
            font-size: 1.1em;
        }
        
        .role-card ul {
            list-style: none;
            padding: 0;
            font-size: 0.9em;
            color: #666;
        }
        
        .role-card ul li {
            margin-bottom: 4px;
        }

        .start-interview-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .api-key-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            text-align: center;
        }

        /* Chat Section */
        .chat-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: var(--radius);
            padding: 20px;
            height: 450px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 10px;
            scroll-behavior: smooth;
        }
        
        .message {
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 85%;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        
        .message.user {
            background: var(--primary);
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        
        .message.bot {
            background: #e2e6ea;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
        }
        
        .input-group input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 25px;
            font-size: 16px;
            margin-right: 10px;
        }
        
        .input-group .btn {
            border-radius: 25px;
            padding: 10px 18px;
        }
        
        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: var(--radius);
            font-size: 14px;
        }
        
        .loading {
            display: inline-block;
            width: 15px;
            height: 15px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes pastelFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
        
            .role-card {
                width: 100%;
            }
        
            .chat-container {
                height: 400px;
            }
        
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
        
            .input-group input,
            .input-group .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        
            .input-group .btn {
                margin: 0;
            }
        }

        /* Media Queries for Responsiveness */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 20px;
                margin: 10px 0;
            }

            .role-card {
                width: 100%; /* Make role cards full width on small screens */
            }

            .chat-container {
                height: 400px;
                padding: 15px;
            }

            .message {
                padding: 10px 15px;
            }

            .input-group {
                flex-wrap: wrap;
            }

            .input-group input {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
            }

            .input-group .btn {
                width: 48%; /* Adjust button width */
                margin: 0 1%; /* Add small margin between buttons */
            }
        
            .theme-toggle-btn {
                position: absolute;
                top: 20px;
                right: 60px;
                cursor: pointer;
                font-size: 1.8rem;
                z-index: 1000;
                user-select: none;
                perspective: 500px;
            }

            /* Dark theme background and content */
            #theme-toggle:checked ~ .wrapper {
                background: linear-gradient(135deg, #f99225, #c20745);
            }

            #theme-toggle:checked ~ .wrapper .container {
                background-color: #2c2c2e;
                color: #f0f0f0;
                box-shadow: 0 8px 30px rgba(78, 31, 54, 0.118);
                transition: background 0.4s ease, color 0.4s ease;
            }

            #theme-toggle:checked ~ .wrapper .button {
                background-color: #c51e50;
                color: white;
                border: 2px solid #2c2c2e;
                transition: background 0.3s ease;
            }

            /* Both icons stacked in same spot */
            .theme-toggle-btn .icon {
                position: absolute;
                transition: transform 0.6s ease, opacity 0.3s ease;
                backface-visibility: hidden; /* Needed for 3D flip */
            }

            /* üåû icon visible in light mode */
            .theme-toggle-btn .sun {
                opacity: 1;
                transform: rotateY(0deg);
            }

            /* üåô icon hidden and flipped */
            .theme-toggle-btn .moon {
                opacity: 0;
                transform: rotateY(180deg);
            }

            /* On toggle (dark mode) ‚Äì reverse the flip */
            #theme-toggle:checked ~ .wrapper .theme-toggle-btn .sun {
                opacity: 0;
                transform: rotateY(180deg);
            }

            #theme-toggle:checked ~ .wrapper .theme-toggle-btn .moon {
                opacity: 1;
                transform: rotateY(0deg);
            }
        }
    </style>
</head>
<body>
    <button class="toggle" id="themeToggle" style="position: absolute; top: 20px; right: 20px;" onclick="toggleTheme()">üåô</button>

    <div class="container">
        <div class="status-indicator hidden" id="statusMessage"></div>
        
        <section id="authSection" class="section show">
            <h1>Welcome to InterviewAce!</h1>
            <p>Your AI-powered interview coach.</p>

            <div class="card-container">

                <div class="card" id="flipCard">
                    <!-- FRONT: Login -->
                    <div class="card-face card-front">
                        <h2>Login</h2>
                        <input type="email" id="loginEmail" placeholder="Email" required>
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <button class="link-btn" onclick="handleForgotPassword()">Forgot password?</button>
                        <button class="btn" onclick="login()">Login</button>
                        <button class="link-btn" onclick="flipToRegister()">Don't have an account? Register here.</button>
                    </div>

                    <!-- BACK: Register -->
                    <div class="card-face card-back">
                        <h2>Register</h2>
                        <input type="text" id="regName" placeholder="Name" required>
                        <input type="email" id="regEmail" placeholder="Email" required>
                        <input type="password" id="regPassword" placeholder="Password" required>
                        <input type="text" id="regSecurityQuestion" placeholder="Security question (e.g. Your pet's name?)" required>
                        <input type="text" id="regSecurityAnswer" placeholder="Your answer" required>
                        <button class="btn" onclick="register()">Register</button>
                        <button class="link-btn" onclick="flipToLogin()">Already have an account? Login here.</button>
                    </div>
                </div>
            </div>
        </section>


        <section id="roleSection" class="section">
            <h1>Choose Your Interview Focus</h1>
            <p>Select a role to begin your tailored interview preparation.</p>

            <div class="role-selection">
                <div class="role-card" onclick="selectRole('fullstack')">
                    <h3>Full Stack Developer</h3>
                    <ul>
                        <li>React/Vue/Angular</li>
                        <li>Node.js/Express</li>
                        <li>Databases</li>
                        <li>APIs</li>
                        <li>System Design</li>
                    </ul>
                </div>
                <div class="role-card" onclick="selectRole('aiml')">
                    <h3>AI/ML Engineer</h3>
                    <ul>
                        <li>Machine Learning</li>
                        <li>Deep Learning</li>
                        <li>Data Science</li>
                        <li>Python ML Libraries</li>
                        <li>Statistics</li>
                    </ul>
                </div>
                <div class="role-card" onclick="selectRole('testing')">
                    <h3>QA/Testing Engineer</h3>
                    <ul>
                        <li>Manual Testing</li>
                        <li>Automation Testing</li>
                        <li>Test Planning</li>
                        <li>Bug Tracking</li>
                        <li>Performance Testing</li>
                    </ul>
                </div>
                <div class="role-card" onclick="selectRole('software')">
                    <h3>Software Developer</h3>
                    <ul>
                        <li>Data Structures</li>
                        <li>Algorithms</li>
                        <li>OOP Principles</li>
                        <li>System Design</li>
                        <li>Code Review</li>
                    </ul>
                </div>
                <div class="role-card" onclick="selectRole('devops')">
                    <h3>DevOps Engineer</h3>
                    <ul>
                        <li>CI/CD</li>
                        <li>Docker/Kubernetes</li>
                        <li>Cloud Services (AWS/Azure)</li>
                        <li>Monitoring</li>
                        <li>Infrastructure as Code</li>
                    </ul>
                </div>
            </div>

            <div class="start-interview-section">
                <div class="form-group">
                    <label for="apiKey">Optional: Enter your OpenAI API Key (for advanced AI features):</label>
                    <input type="password" id="apiKey" class="api-key-input" placeholder="sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX">
                    <p style="font-size: 0.8em; color: #777;">*If left blank, a default key will be used for mock responses only.</p>
                </div>
                <button class="btn" onclick="startInterview()">Start Interview</button>
                <button class="btn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);" onclick="logout()">Logout</button>
            </div>
        </section>

        <section id="chatSection" class="section">
            <h1 id="chatTitle">Interview Preparation: Role Name</h1>
            <div class="chat-container">
                <div id="chatMessages">
                    <div class="message bot">Welcome! I'm your AI interview coach. Let's start with some questions to help you prepare. Type 'start' to begin!</div>
                </div>
                <div class="input-group">
                    <input type="text" id="userInput" placeholder="Type or speak your answer here..." onkeypress="handleKeyPress(event)">
                    <button class="btn" onclick="sendMessage()">Send</button>
                    <button class="btn" id="micButton" style="background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);" onclick="toggleVoiceInput()">üéôÔ∏è</button>
                    <button class="btn" id="speakToggleButton" style="background: linear-gradient(135deg, #673AB7 0%, #9C27B0 100%);" onclick="toggleSpeechOutput()">üîä</button>
                </div>
            </div>
            <button class="btn" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); margin-top: 20px;" onclick="endInterview()">End Interview Session</button>
        </section>
    </div>

    <script>
        function flipToRegister() {
            document.getElementById('flipCard').classList.add('flipped');
        }

        function flipToLogin() {
            document.getElementById('flipCard').classList.remove('flipped');
        }
        
        function handleForgotPassword() {
            const email = prompt("Enter your registered email:");
            if (!email) return;

            fetch('/forgot-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            })
            .then(res => res.json())
            .then(data => alert(data.message))
            .catch(err => alert("Error: " + err.message));
        }


        // dark mode toggle
        function toggleTheme() {
            const body = document.body;
            const button = document.getElementById('themeToggle');

            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            button.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Global state
        let currentUser = null;
        let selectedRole = null;
        let apiKey = null;
        let questionCount = 0;
        let maxQuestions = 5;
        let currentQuestionIndex = 0;
        let askedQuestions = [];

        // Mock user database
        let users = JSON.parse(localStorage.getItem('interviewBotUsers') || '[]');

        // Default OpenAI API Key (replace with your actual key)
        const DEFAULT_API_KEY = "YOUR_OPENAI_API_KEY_HERE"; // IMPORTANT: Replace with your actual key if you want AI features to work

        // Speech Recognition variables
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;

        // Speech Synthesis variables
        let synth = window.speechSynthesis;
        let speechEnabled = true; // Default to speech enabled
        let voices = [];

        // Role configurations (keep this as is)
        const roleConfigs = {
            fullstack: {
                title: "Full Stack Developer",
                topics: ["React/Vue/Angular", "Node.js/Express", "Databases", "APIs", "System Design", "Cloud Services"],
                questions: [
                    {
                        question: "What is the difference between REST and GraphQL APIs?",
                        keywords: ["rest", "graphql", "endpoint", "query", "flexibility", "caching", "overfetching"],
                        correctAnswer: "REST uses multiple endpoints with fixed data structures, while GraphQL uses a single endpoint with flexible queries. GraphQL allows clients to request specific data, reducing overfetching, but REST has better caching mechanisms."
                    },
                    {
                        question: "How would you handle state management in a large React application?",
                        keywords: ["redux", "context", "state", "component", "props", "global", "local"],
                        correctAnswer: "Use Redux or Context API for global state, keep local state in components when possible, use useReducer for complex state logic, and consider state normalization for nested data."
                    },
                    {
                        question: "Explain the concept of database indexing and its impact on performance.",
                        keywords: ["index", "performance", "query", "btree", "hash", "primary", "foreign", "optimization"],
                        correctAnswer: "Database indexes are data structures that improve query performance by creating shortcuts to data. They speed up SELECT operations but slow down INSERT/UPDATE/DELETE operations due to index maintenance."
                    },
                    {
                        question: "How would you implement authentication and authorization in a web application?",
                        keywords: ["jwt", "session", "token", "oauth", "authentication", "authorization", "security", "middleware"],
                        correctAnswer: "Use JWT tokens or sessions for authentication, implement role-based access control for authorization, secure endpoints with middleware, and consider OAuth for third-party authentication."
                    },
                    {
                        question: "What are microservices and what are their advantages and disadvantages?",
                        keywords: ["microservices", "monolith", "scalability", "deployment", "communication", "database", "complexity"],
                        correctAnswer: "Microservices are small, independent services that communicate over networks. Advantages: scalability, technology diversity, fault isolation. Disadvantages: complexity, network overhead, distributed system challenges."
                    }
                ]
            },
            aiml: {
                title: "AI/ML Engineer",
                topics: ["Machine Learning", "Deep Learning", "Data Science", "Python", "TensorFlow/PyTorch", "Statistics"],
                questions: [
                    {
                        question: "What is the bias-variance tradeoff and how do you handle it?",
                        keywords: ["bias", "variance", "overfitting", "underfitting", "regularization", "cross-validation", "complexity"],
                        correctAnswer: "Bias-variance tradeoff refers to the balance between model complexity and generalization. High bias leads to underfitting, high variance to overfitting. Handle with regularization, cross-validation, and proper model selection."
                    },
                    {
                        question: "Explain the difference between supervised, unsupervised, and reinforcement learning.",
                        keywords: ["supervised", "unsupervised", "reinforcement", "labels", "clustering", "classification", "reward"],
                        correctAnswer: "Supervised learning uses labeled data for prediction tasks. Unsupervised learning finds patterns in unlabeled data. Reinforcement learning learns through interaction with environment using rewards and penalties."
                    },
                    {
                        question: "How do you handle missing data in a machine learning dataset?",
                        keywords: ["missing", "imputation", "deletion", "mean", "median", "interpolation", "knn", "multiple"],
                        correctAnswer: "Handle missing data through deletion (listwise/pairwise), imputation (mean/median/mode), interpolation, KNN imputation, or multiple imputation. Choice depends on data pattern and amount of missing values."
                    },
                    {
                        question: "What is gradient descent and what are its variants?",
                        keywords: ["gradient", "descent", "optimization", "learning", "rate", "batch", "stochastic", "momentum"],
                        correctAnswer: "Gradient descent is an optimization algorithm that minimizes cost function by iteratively moving toward steepest descent. Variants include batch, stochastic, mini-batch, and advanced optimizers like Adam, RMSprop."
                    },
                    {
                        question: "Explain the concept of feature engineering and its importance.",
                        keywords: ["feature", "engineering", "selection", "extraction", "transformation", "scaling", "encoding", "polynomial"],
                        correctAnswer: "Feature engineering involves creating, transforming, and selecting features to improve model performance. Includes scaling, encoding categorical variables, creating polynomial features, and domain-specific transformations."
                    }
                ]
            },
            testing: {
                title: "QA/Testing Engineer",
                topics: ["Manual Testing", "Automation", "Test Planning", "Bug Tracking", "Performance Testing", "Security Testing"],
                questions: [
                    {
                        question: "What is the difference between smoke testing and sanity testing?",
                        keywords: ["smoke", "sanity", "build", "functionality", "subset", "narrow", "wide", "verification"],
                        correctAnswer: "Smoke testing verifies basic functionality of entire application after new build. Sanity testing is narrow, focused testing of specific functionality after minor changes or bug fixes."
                    },
                    {
                        question: "How would you design a test strategy for a mobile application?",
                        keywords: ["mobile", "device", "platform", "usability", "performance", "network", "battery", "security"],
                        correctAnswer: "Consider device compatibility, platform differences (iOS/Android), network conditions, battery usage, touch interactions, orientation changes, performance testing, and security testing."
                    },
                    {
                        question: "What are the key components of a test plan?",
                        keywords: ["test", "plan", "scope", "objectives", "strategy", "schedule", "resources", "risks", "deliverables"],
                        correctAnswer: "Test plan includes test objectives, scope, approach, schedule, resources, test environment, entry/exit criteria, deliverables, risks, and contingencies."
                    },
                    {
                        question: "Explain the difference between functional and non-functional testing.",
                        keywords: ["functional", "non-functional", "requirements", "performance", "usability", "security", "behavior"],
                        correctAnswer: "Functional testing verifies software functions according to requirements. Non-functional testing checks performance, usability, reliability, security, and other quality attributes."
                    },
                    {
                        question: "How do you prioritize test cases when time is limited?",
                        keywords: ["priority", "risk", "critical", "business", "impact", "probability", "coverage", "requirements"],
                        correctAnswer: "Prioritize based on business impact, risk assessment, critical functionality, customer usage patterns, and regulatory requirements. Focus on high-risk, high-impact areas first."
                    }
                ]
            },
            software: {
                title: "Software Developer",
                topics: ["Data Structures", "Algorithms", "Object-Oriented Programming", "System Design", "Code Review", "Version Control"],
                questions: [
                    {
                        question: "What is the time complexity of QuickSort and when would you use it?",
                        keywords: ["quicksort", "time", "complexity", "average", "worst", "partition", "pivot", "inplace"],
                        correctAnswer: "QuickSort has average time complexity O(n log n) and worst case O(n¬≤). Use when average performance is important, memory is limited (in-place), and data is randomly distributed."
                    },
                    {
                        question: "Explain the SOLID principles with examples.",
                        keywords: ["solid", "single", "open", "closed", "liskov", "interface", "dependency", "inversion"],
                        correctAnswer: "SOLID: Single Responsibility (one reason to change), Open/Closed (open for extension, closed for modification), Liskov Substitution (subclasses should be substitutable), Interface Segregation (specific interfaces), Dependency Inversion (depend on abstractions)."
                    },
                    {
                        question: "How would you implement a LRU (Least Recently Used) cache?",
                        keywords: ["lru", "cache", "hashmap", "doubly", "linked", "list", "get", "put", "eviction"],
                        correctAnswer: "Implement using HashMap for O(1) access and doubly linked list for O(1) insertion/deletion. HashMap stores key-node pairs, linked list maintains usage order."
                    },
                    {
                        question: "What are design patterns and give examples of commonly used ones?",
                        keywords: ["design", "patterns", "singleton", "factory", "observer", "strategy", "decorator", "mvc"],
                        correctAnswer: "Design patterns are reusable solutions to common problems. Examples: Singleton (single instance), Factory (object creation), Observer (event handling), Strategy (algorithm selection), MVC (separation of concerns)."
                    },
                    {
                        question: "Explain the difference between stack and heap memory allocation.",
                        keywords: ["stack", "heap", "memory", "allocation", "automatic", "dynamic", "scope", "garbage"],
                        correctAnswer: "Stack stores local variables and function calls with automatic memory management and limited size. Heap stores dynamically allocated objects with manual/garbage collection management and larger size."
                    }
                ]
            },
            devops: {
                title: "DevOps Engineer",
                topics: ["CI/CD", "Docker", "Kubernetes", "AWS/Azure", "Monitoring", "Infrastructure as Code"],
                questions: [
                    {
                        question: "What are the key stages of a CI/CD pipeline?",
                        keywords: ["ci", "cd", "pipeline", "build", "test", "deploy", "integration", "delivery", "automation"],
                        correctAnswer: "CI/CD pipeline stages: Source control trigger, build compilation, automated testing, artifact creation, deployment to staging, production deployment, and monitoring. Ensures automated, reliable software delivery."
                    },
                    {
                        question: "Explain the difference between Docker containers and virtual machines.",
                        keywords: ["docker", "container", "virtual", "machine", "os", "kernel", "isolation", "resources"],
                        correctAnswer: "Containers share host OS kernel with process isolation, lightweight and fast startup. VMs include full OS with hardware virtualization, heavier but stronger isolation. Containers are more efficient for microservices."
                    },
                    {
                        question: "How would you implement monitoring and alerting for a production system?",
                        keywords: ["monitoring", "alerting", "metrics", "logs", "prometheus", "grafana", "elk", "sla"],
                        correctAnswer: "Implement using metrics collection (Prometheus), visualization (Grafana), log aggregation (ELK stack), health checks, SLA monitoring, and automated alerting based on thresholds and anomalies."
                    },
                    {
                        question: "What is Infrastructure as Code and what are its benefits?",
                        keywords: ["infrastructure", "code", "terraform", "ansible", "cloudformation", "version", "control", "automation"],
                        correctAnswer: "Infrastructure as Code manages infrastructure through code (Terraform, Ansible). Benefits: version control, reproducibility, automation, consistency, documentation, and reduced manual errors."
                    },
                    {
                        question: "How do you ensure high availability in a distributed system?",
                        keywords: ["availability", "distributed", "redundancy", "failover", "load", "balancing", "replication", "disaster"],
                        correctAnswer: "Ensure high availability through redundancy, load balancing, automatic failover, data replication, health monitoring, disaster recovery planning, and designing for failure scenarios."
                    }
                ]
            }
        };

        // Authentication functions
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function register() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const question = document.getElementById('regSecurityQuestion').value;
            const answer = document.getElementById('regSecurityAnswer').value;

            if (!name || !email || !password || !question || !answer) {
                alert("Please fill in all fields.");
                return;
            }

            const user = { name, email, password, question, answer };
            localStorage.setItem(email, JSON.stringify(user));

            alert("Registered successfully!");
            flipToLogin();
        }

        function handleForgotPassword() {
            const email = prompt("Enter your registered email:");
            if (!email) return;

            const userData = localStorage.getItem(email);
            if (!userData) return alert("No account found with this email.");

            const user = JSON.parse(userData);
            const answer = prompt(`Security question:\n${user.question}`);

            if (answer.toLowerCase().trim() === user.answer.toLowerCase().trim()) {
                const newPassword = prompt("Correct! Enter your new password:");
                if (newPassword) {
                user.password = newPassword;
                localStorage.setItem(email, JSON.stringify(user));
                alert("Password reset successful!");
                }
            } else {
                alert("Incorrect answer. Cannot reset password.");
            }
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showStatus('Please fill in all fields', 'error');
                return;
            }

            const userData = localStorage.getItem(email);
            if (!userData) {
                showStatus('No account found with this email.', 'error');
                return;
            }

            const user = JSON.parse(userData);
            if (user.password !== password) {
                showStatus('Invalid credentials', 'error');
                return;
            }

            currentUser = user;
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('roleSection').classList.add('show');
            
            showStatus(`Welcome back, ${user.name}!`, 'success');
        }

        function logout() {
            currentUser = null;
            selectedRole = null;
            apiKey = null;
            questionCount = 0;
            askedQuestions = [];
            
            document.getElementById('roleSection').classList.remove('show');
            document.getElementById('chatSection').classList.remove('show');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('regName').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            
            clearChatMessages();
            showStatus('Logged out successfully.', 'success');
            // Stop any active speech recognition or synthesis
            if (isListening && recognition) {
                recognition.stop();
                isListening = false;
                document.getElementById('micButton').style.background = 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)';
            }
            if (synth.speaking) {
                synth.cancel();
            }
        }

        // Role Selection functions
        function selectRole(roleKey) {
            // Remove 'selected' class from all role cards
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add 'selected' class to the clicked role card
            const selectedCard = event.currentTarget;
            selectedCard.classList.add('selected');
            
            selectedRole = roleKey;
        }

        function startInterview() {
            if (!selectedRole) {
                showStatus('Please select an interview focus role.', 'error');
                return;
            }

            apiKey = document.getElementById('apiKey').value || DEFAULT_API_KEY;

            document.getElementById('roleSection').classList.remove('show');
            document.getElementById('chatSection').classList.add('show');
            document.getElementById('chatTitle').textContent = `Interview Preparation: ${roleConfigs[selectedRole].title}`;
            
            clearChatMessages();
            addMessage("bot", `Great choice! We'll start your interview preparation for **${roleConfigs[selectedRole].title}**. Type 'start' to receive your first question.`, true); // Speak this message
            
            questionCount = 0;
            currentQuestionIndex = 0;
            askedQuestions = [];
        }

        function endInterview() {
            if (confirm("Are you sure you want to end this interview session? Your progress will be reset.")) {
                selectedRole = null;
                questionCount = 0;
                currentQuestionIndex = 0;
                askedQuestions = [];
                document.getElementById('chatSection').classList.remove('show');
                document.getElementById('roleSection').classList.add('show');
                clearChatMessages();
                addMessage("bot", "Welcome! I'm your AI interview coach. Let's start with some questions to help you prepare. Type 'start' to begin!");
                showStatus('Interview session ended.', 'info');
                // Stop listening if currently active
                if (isListening && recognition) {
                    recognition.stop();
                    isListening = false;
                    document.getElementById('micButton').style.background = 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)'; // Reset button color
                }
                // Stop speaking if currently active
                if (synth.speaking) {
                    synth.cancel();
                }
            }
        }

        // Chat functions
        function addMessage(sender, text, speak = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.innerHTML = text; // Use innerHTML to render bold/markdown
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            if (speak && speechEnabled) {
                speakText(text);
            }
        }

        function clearChatMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const userInputField = document.getElementById('userInput');
            const userText = userInputField.value.trim();

            if (userText === '') return;

            // If listening, stop it before sending the message
            if (isListening && recognition) {
                recognition.stop();
                isListening = false;
                document.getElementById('micButton').style.background = 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)';
            }
            // If speaking, stop it before sending the message
            if (synth.speaking) {
                synth.cancel();
            }

            addMessage('user', userText);
            userInputField.value = '';

            if (userText.toLowerCase() === 'start') {
                await askNextQuestion();
            } else if (askedQuestions.length > 0) {
                const currentQuestion = askedQuestions[askedQuestions.length - 1];
                await evaluateAnswer(currentQuestion, userText);
                // After evaluation, check if it's time for the next question
                if (questionCount < maxQuestions) {
                     await askNextQuestion();
                } else {
                    addMessage('bot', "You've completed all the practice questions for this session! Great job! If you want to continue, you can start a new session or choose a different role.", true);
                }
            } else {
                addMessage('bot', "Please type or speak 'start' to begin your interview preparation.", true);
            }
        }

        async function askNextQuestion() {
            if (!selectedRole || !roleConfigs[selectedRole]) {
                addMessage('bot', "An error occurred. Please select a role first.", true);
                return;
            }

            const roleQuestions = roleConfigs[selectedRole].questions;

            if (questionCount >= maxQuestions) {
                // This case is already handled after evaluateAnswer, but kept for direct "start" if max questions reached.
                addMessage('bot', "You've completed all the practice questions for this session! Great job! If you want to continue, you can start a new session or choose a different role.", true);
                return;
            }

            if (currentQuestionIndex < roleQuestions.length) {
                const nextQuestion = roleQuestions[currentQuestionIndex];
                addMessage('bot', nextQuestion.question, true); // Speak the question
                askedQuestions.push(nextQuestion);
                questionCount++;
                currentQuestionIndex++;
            } else {
                addMessage('bot', "You've gone through all the pre-defined questions for this role. If you want more practice, you can start a new session or choose a different role.", true); // Speak this message
            }
        }

        function showStatus(message, type) {
            let statusDiv = document.getElementById('statusMessage');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.classList.add('status-indicator');
                statusDiv.id = 'statusMessage';
                document.querySelector('.container').prepend(statusDiv);
            }
            statusDiv.textContent = message;
            statusDiv.className = `status-indicator status-${type} show`;

            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 5000);
        }

        async function evaluateAnswer(question, userAnswer) {
            addMessage('bot', `<span class="loading"></span> Evaluating your answer...`);
            const chatMessages = document.getElementById('chatMessages');
            const loadingMessage = chatMessages.lastChild;

            try {
                // Simulate AI evaluation (replace with actual API call)
                const evaluationResult = await mockAIEvaluation(question, userAnswer);
                loadingMessage.remove();
                addMessage('bot', evaluationResult, true); // Speak the evaluation feedback
            } catch (error) {
                loadingMessage.remove();
                addMessage('bot', 'Sorry, I could not evaluate your answer at this moment. Please try again.', true);
                console.error("Evaluation error:", error);
            }
        }

        async function mockAIEvaluation(questionData, userAnswer) {
            const userLower = userAnswer.toLowerCase();
            const keywords = questionData.keywords;
            let score = 0;
            let feedback = "";

            keywords.forEach(keyword => {
                if (userLower.includes(keyword)) {
                    score++;
                }
            });

            if (score >= keywords.length * 0.7) {
                feedback = "Excellent answer! You covered the key points well. ";
            } else if (score >= keywords.length * 0.4) {
                feedback = "Good start! Your answer shows some understanding, but you could elaborate more on some key aspects. ";
            } else {
                feedback = "That's a good attempt, but your answer missed some critical points. ";
            }

            feedback += `\n\n**Here's a comprehensive answer:**\n${questionData.correctAnswer}`;
            
            return new Promise(resolve => {
                setTimeout(() => resolve(feedback), 1500);
            });
        }

        // Voice Input Functions (Speech Recognition)
        function initializeSpeechRecognition() {
            if (!SpeechRecognition) {
                showStatus("Speech recognition is not supported in your browser.", "error");
                document.getElementById('micButton').disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false; // Only listen for a single utterance
            recognition.lang = 'en-US'; // Set language

            recognition.onstart = function() {
                isListening = true;
                document.getElementById('userInput').placeholder = "Listening...";
                document.getElementById('micButton').style.background = 'linear-gradient(135deg, #FF5722 0%, #FFC107 100%)'; // Orange/Yellow for active
                showStatus("Listening for your answer...", "info");
                if (synth.speaking) { // Stop bot speech if user starts speaking
                    synth.cancel();
                }
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('userInput').value = transcript;
                sendMessage(); // Automatically send the message after recognition
                isListening = false;
                document.getElementById('micButton').style.background = 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)'; // Reset button color
                document.getElementById('userInput').placeholder = "Type or speak your answer here...";
            };

            recognition.onerror = function(event) {
                console.error("Speech recognition error:", event.error);
                showStatus(`Speech recognition error: ${event.error}. Please try again.`, "error");
                isListening = false;
                document.getElementById('micButton').style.background = 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)'; // Reset button color
                document.getElementById('userInput').placeholder = "Type or speak your answer here...";
            };

            recognition.onend = function() {
                if (isListening) { // Only change state if it was actively listening and not manually stopped
                    isListening = false;
                    document.getElementById('micButton').style.background = 'linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%)'; // Reset button color
                    document.getElementById('userInput').placeholder = "Type or speak your answer here...";
                }
                showStatus("Speech recognition stopped.", "info");
            };
        }

        function toggleVoiceInput() {
            if (!recognition) {
                showStatus("Speech recognition is not available. Please try a different browser.", "error");
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        // Text-to-Speech Functions (Speech Synthesis)
        function initializeSpeechSynthesis() {
            if (!synth) {
                showStatus("Text-to-speech is not supported in your browser.", "error");
                document.getElementById('speakToggleButton').disabled = true;
                speechEnabled = false;
                return;
            }

            // Get voices when they are loaded
            synth.onvoiceschanged = () => {
                voices = synth.getVoices();
                // Optionally, find a specific voice like "Google US English" or a regional one
                // let preferredVoice = voices.find(voice => voice.name === 'Google US English' && voice.lang === 'en-US');
                // if (preferredVoice) {
                //     // You can store this preferred voice or use it in speakText
                // }
                console.log("Voices loaded:", voices);
            };

            // If voices are already loaded (e.g., on subsequent page loads or after a short delay)
            if (synth.getVoices().length > 0) {
                voices = synth.getVoices();
                console.log("Voices immediately available:", voices);
            }
        }

        function speakText(text) {
            if (!speechEnabled || !synth) {
                return;
            }

            // Remove markdown like ** or ## for better speech
            const cleanedText = text.replace(/\*\*(.*?)\*\*/g, '$1').replace(/##\s*/g, '');

            const utterance = new SpeechSynthesisUtterance(cleanedText);
            utterance.lang = 'en-US';
            utterance.volume = 1; // 0 to 1
            utterance.rate = 1;   // 0.1 to 10
            utterance.pitch = 1;  // 0 to 2

            // Optionally, choose a specific voice
            // let selectedVoice = voices.find(voice => voice.name === 'Google US English');
            // if (selectedVoice) {
            //     utterance.voice = selectedVoice;
            // }

            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                showStatus(`Speech output error: ${event.error}`, "error");
            };

            synth.speak(utterance);
        }

        function toggleSpeechOutput() {
            speechEnabled = !speechEnabled;
            const speakButton = document.getElementById('speakToggleButton');
            if (speechEnabled) {
                speakButton.style.background = 'linear-gradient(135deg, #673AB7 0%, #9C27B0 100%)'; // Purple for enabled
                speakButton.textContent = 'üîä';
                showStatus("Speech output enabled.", "info");
            } else {
                speakButton.style.background = 'linear-gradient(135deg, #9E9E9E 0%, #616161 100%)'; // Grey for disabled
                speakButton.textContent = 'üîá';
                if (synth.speaking) {
                    synth.cancel(); // Stop any ongoing speech
                }
                showStatus("Speech output disabled.", "info");
            }
        }


        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeSpeechRecognition(); // Initialize speech recognition
            initializeSpeechSynthesis(); // Initialize speech synthesis

            if (currentUser) {
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('roleSection').classList.add('show');
                showStatus(`Welcome back, ${currentUser.name}!`, 'success');
            } else {
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('roleSection').classList.remove('show');
                document.getElementById('chatSection').classList.remove('show');
            }
        });

    </script>
</body>
</html>
